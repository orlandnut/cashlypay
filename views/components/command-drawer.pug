mixin commandDrawer(opts)
  - const options = opts || {};
  - const links = Array.isArray(options.links) ? options.links : [];
  - const actions = Array.isArray(options.actions) ? options.actions : [];
  - const currentPath = options.currentPath || "";
  - const status = typeof options.status === 'object' ? options.status : null;
  - const drawerEnvLabel = status && status.label ? `${status.label} mode` : null;
  - const drawerEnvTone = drawerEnvLabel ? ((status && status.tone) ? status.tone : (drawerEnvLabel.toLowerCase().includes('live') ? 'live' : 'sandbox')) : null;
  -
    const defaultLinks = links.length
      ? links
      : [
          { label: "Dashboard", href: "/", match: "/", icon: "#icon-dashboard", meta: "Command overview" },
          { label: "Customer Hub", href: "/customers", match: ["/customers", "/management"], icon: "#icon-invoice", meta: "Accounts & billing" },
          { label: "Invoices", href: "/invoice/create", match: "/invoice", icon: "#icon-invoice", meta: "Composer & history" },
          { label: "Estimates", href: "/estimate", match: "/estimate", icon: "#icon-dashboard", meta: "Quotes & approvals" },
          { label: "Subscriptions", href: "/subscription", match: "/subscription", icon: "#icon-dashboard", meta: "Recurring services" },
          { label: "Analytics", href: "/analytics", match: "/analytics", icon: "#icon-dashboard", meta: "KPIs & health" },
          { label: "Reminder Queue", href: "/admin/reminders", match: "/admin", icon: "#icon-invoice", meta: "Automation feed" },
          { label: "Settings", href: "/admin", match: "/settings", icon: "#icon-dashboard", meta: "Controls & access" }
        ];
  -
    const defaultActions = actions.length
      ? actions
      : [
          { label: "Create Invoice", href: "/invoice/create", tone: "primary" },
          { label: "Run Reminder Queue", href: "/admin/reminders", tone: "danger", confirm: "Run the reminder queue now?" }
        ];
  -
    const inlineInvoiceAction = defaultActions.find((action) =>
      action.label && action.label.toLowerCase().includes("create invoice")
    );
  -
    const drawerActions = defaultActions.filter((action) => action !== inlineInvoiceAction);

  .command-drawer(id="commandDrawer" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Navigation drawer")
    .command-drawer__panel
      .command-drawer__header
        .command-drawer__brand
          a.command-drawer__brand-lockup(href="/")
            span.sr-only CashlyPay home
            .brand-chip.brand-chip--mini.command-drawer__brand-chip
              .brand-chip__row
                .brand-chip__icon
                  img(src="/images/cashly-logo.png" alt="CashlyPay mark" width="42" height="42" loading="lazy" decoding="async")
                .brand-chip__body
                  span.brand-chip__eyebrow Navigate & automate
                  .brand-chip__wordmark.wordmark.wordmark--compact
                    span.wordmark__main Cashly
                    span.wordmark__accent Pay
                .brand-chip__badge
                  span.brand-chip__status-bar
                  span.brand-chip__pulse
        if drawerEnvLabel
          span.command-drawer__env(class=`env-pill env-pill--${drawerEnvTone === 'live' ? 'live' : 'sandbox'}`)
            span.env-pill__dot
            span.env-pill__label= drawerEnvLabel
        button.command-drawer__close(type="button" aria-label="Close navigation panel")
          span
      nav.command-drawer__nav
        ul
          each link in defaultLinks
            -
              const matchTarget = link.match || link.href;
              const matches = Array.isArray(matchTarget) ? matchTarget : [matchTarget];
              const isActive = matches.some((target) =>
                target ? currentPath === target || currentPath.startsWith(target) : false
              );
            li
              .command-drawer__nav-row
                a.command-drawer__nav-link(class=isActive ? 'active' : '' href=link.href)
                  if link.icon
                    span.command-drawer__nav-icon
                      svg(width="20" height="20" aria-hidden="true")
                        use(href=link.icon)
                  span.command-drawer__nav-body
                    span.command-drawer__nav-label= link.label
                    if link.meta
                      span.command-drawer__nav-meta= link.meta
                if inlineInvoiceAction && link.label === "Invoices"
                  a.command-drawer__inline-action.button.button-secondary.button-sm(href=inlineInvoiceAction.href)= inlineInvoiceAction.label
      if drawerActions.length
        .command-drawer__actions
          each action in drawerActions
            - const tone = action.tone || "primary";
            - let btnClass = "button button-primary";
            - if (tone === "secondary") btnClass = "button button-secondary";
            - else if (tone === "ghost") btnClass = "button button-ghost";
            - else if (tone === "danger") btnClass = "button button-danger";
            a(
              class=btnClass
              href=action.href
              data-confirm=action.confirm || null
              data-run-reminders=action.tone === "danger" ? "true" : null
            )= action.label
