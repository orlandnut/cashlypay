extends layout

block hero
  +darkHero({
    title: "Customer Hub",
    subtitle: "Browse and manage every customer profile from a unified workspace.",
    actions: [
      { type: "primary", label: "Add Customer", href: "/customers/new" }
    ],
    status: envStatus
  })

block content
  - const managementLocationId = locationId || 'main'
  - const formatCardBalance = (money) => {
  -   const amount = money && typeof money.amount === 'number' ? money.amount : 0;
  -   const currency = (money && money.currency) || 'USD';
  -   return `$${(amount / 100).toFixed(2)} ${currency}`;
  - }
  - const formatCardDate = (value) => value ? new Date(value).toLocaleString() : '—'
  - const cardCount = cardCustomers || 0
  - const manualCount = manualCustomers || Math.max((totalCustomers || 0) - cardCount, 0)
  main.dashboard
    section.section.panel
      .section-header
        h2.section-title Customer Directory
        .section-actions
          a.button.button-secondary.button-sm(href="/customers/new") Add Customer
      if totalCustomers
        .customer-stats
          .stat-card
            span.stat-label Total customers
            span.stat-value #{totalCustomers}
          .stat-card
            span.stat-label Cards on file
            span.stat-value #{cardCount}
          .stat-card
            span.stat-label Manual billing
            span.stat-value #{manualCount}
      if customers && customers.length
        .customers-list
          each customer in customers
            - const displayName = `${customer.givenName || 'Customer'} ${customer.familyName || ''}`.trim()
            - const avatarLetter = displayName ? displayName.charAt(0).toUpperCase() : 'C'
            - const email = customer.emailAddress || 'Email unavailable'
            - const organization = customer.companyName
            - const customerCode = customer.id ? customer.id.substring(0, 6).toUpperCase() : '—'
            - const hasCard = customer.cards && customer.cards.length
            - const paymentLabel = hasCard ? 'Card on file' : 'Manual billing'
            - const paymentMeta = hasCard ? `${customer.cards[0].cardBrand || 'Card'} •••• ${customer.cards[0].last4 || '0000'}` : 'Sync payment source'
            - const phoneMeta = customer.phoneNumber ? customer.phoneNumber : null
            - const linkedCards = (customerGiftCards && customerGiftCards[customer.id]) || []
            .customer-card
              a.customer-link(href=customer.id ? `/management/${managementLocationId}/${customer.id}` : '#')
                .customer-card__halo
                .customer-card__body
                  .customer-card__identity
                    .customer-avatar
                      span.avatar-letter #{avatarLetter}
                      span.avatar-ring
                    .identity-copy
                      span.identity-label Customer profile
                      h3.customer-name #{displayName}
                      p.customer-email #{email}
                      span.customer-id ID ##{customerCode}
                      if organization
                        span.company-name #{organization}
                  .customer-card__stats
                    span.status-pill(class=`status-pill--${hasCard ? 'primary' : 'neutral'}`) #{paymentLabel}
                    span.card-brand #{paymentMeta}
                    if phoneMeta
                      span.card-meta #{phoneMeta}
                  if linkedCards.length
                    .linked-card-panel
                      span.panel-label Linked gift cards
                      each card in linkedCards
                        .linked-card-pill
                          div
                            strong= card.gan || card.id
                            span.linked-card-balance= formatCardBalance(card.balance)
                            span.linked-card-state #{card.state || '—'}
                            span.linked-card-meta Updated #{formatCardDate(card.updatedAt)}
                          .linked-card-actions
                            a.button.button-ghost.button-sm(href=`/gift-cards?q=${card.id}`) View
                            if permissions && permissions.canManageGiftCards
                              a.button.button-secondary.button-sm(href=`/gift-cards?q=${card.id}#load-card`) Load funds
                  else if permissions && permissions.canManageGiftCards
                    .linked-card-empty
                      span.text-secondary No gift card linked.
                      a.button.button-ghost.button-sm(href=`/gift-cards?customerId=${customer.id}#issue-card`) Issue card
                  .customer-card__cta
                    span.cta-label Command Center
                    svg.icon-arrow(width="20" height="20" viewBox="0 0 24 24" fill="none")
                      path(d="M5 12h14m0 0l-5-5m5 5l-5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
      else
        .empty-state
          svg(width="64" height="64" viewBox="0 0 24 24" fill="none")
            path(d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 100-16 8 8 0 000 16zm-1-11h2v5h-2v-5zm0 6h2v2h-2v-2z" fill="currentColor")
          h3 No customers yet
          p Create your first customer profile to start managing invoices and subscriptions.
          a.button.button-primary(href="/customers/new") Add Customer
