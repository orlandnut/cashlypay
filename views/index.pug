//- Copyright 2020 Square Inc.
 
//- Licensed under the Apache License, Version 2.0 (the "License");
//- you may not use this file except in compliance with the License.
//- You may obtain a copy of the License at
 
//-     http://www.apache.org/licenses/LICENSE-2.0
 
//- Unless required by applicable law or agreed to in writing, software
//- distributed under the License is distributed on an "AS IS" BASIS,
//- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//- See the License for the specific language governing permissions and
//- limitations under the License. 

extends layout

block hero
  - var heroStatusLabel = (envStatus && envStatus.label) || 'Testing'
  +darkHero({
    title: "Modern Customer Workspace",
    subtitle: "Manage clients, invoices, reminders, and analytics from a single hub designed for finance teams on the go.",
    back: false,
    actions: [
      { type: "primary", label: "Customer Hub", href: "/customers" },
      { type: "secondary", label: "View Analytics", href: "/analytics" }
    ],
    status: {
      label: heroStatusLabel === 'Live' ? 'Live Environment' : 'Testing Environment',
      tone: heroStatusLabel === 'Live' ? 'success' : 'warning'
    }
  })


block content
  - const totalCustomers = customers.length
  - const cardCustomers = customers.filter((customer) => customer.cards && customer.cards.length)
  - const manualCustomers = totalCustomers - cardCustomers.length
  - const lastCustomer = customers[0]
  - const statusLabel = typeof heroStatusLabel !== 'undefined' ? heroStatusLabel : (envStatus && envStatus.label) || 'Testing'
  - const primaryCustomerId = lastCustomer && lastCustomer.id
  - const customerDetailHref = primaryCustomerId ? `/management/${locationId}/${primaryCustomerId}` : '/customers/new'
  - const managementHref = customerDetailHref
  - const invoiceHref = customerDetailHref
  - const estimateHref = primaryCustomerId ? `/estimate/new/${locationId}/${primaryCustomerId}` : '/customers/new'
  - const subscriptionHref = primaryCustomerId ? `/subscription/new/${locationId}/${primaryCustomerId}` : '/customers/new'
  - const reminderCountValue = typeof reminderCount === 'number' ? reminderCount : 0
  - const directoryCustomers = Array.isArray(displayCustomers) ? displayCustomers : (customers || [])
  - const settingsHref = '/admin'
  - const safeTickerStats = tickerStats || { upcomingReminders: 0, overdueReminders: 0 }
  - const invoiceTicker = invoiceStats || { overdueInvoiceCount: 0, scheduledInvoiceCount: 0 }
  - const tickerItems = []
  - tickerItems.push({ label: statusLabel === 'Live' ? 'Next settlement ETA' : 'Next sandbox sync', value: statusLabel === 'Live' ? '2h 15m' : 'Sandbox sync in 2h' })
  - tickerItems.push({ label: 'Upcoming reminders', value: safeTickerStats.upcomingReminders })
  - tickerItems.push({ label: 'Overdue reminders', value: safeTickerStats.overdueReminders })
  - tickerItems.push({ label: 'Overdue invoices', value: invoiceTicker.overdueInvoiceCount })
  - tickerItems.push({ label: 'Scheduled invoices', value: invoiceTicker.scheduledInvoiceCount })
  - const heroSignals = []
  - heroSignals.push({ label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job waiting to send" : `${reminderCountValue} reminders staged` })
  - heroSignals.push({ label: "Upcoming reminders", value: safeTickerStats.upcomingReminders, meta: "Next 24h window" })
  - heroSignals.push({ label: "Overdue reminders", value: safeTickerStats.overdueReminders, meta: safeTickerStats.overdueReminders ? "Escalate with ops" : "All clear" })
  - heroSignals.push({ label: "Scheduled invoices", value: invoiceTicker.scheduledInvoiceCount, meta: "In-flight billing" })
  - const cardCoverage = totalCustomers ? Math.round((cardCustomers.length / totalCustomers) * 100) : 0
  - const payoutHeadline = payoutStats ? `${payoutStats.pending} pending via ${payoutStats.lastRail || 'rail TBD'}` : "No payouts pending"
  - const customerBadge = lastCustomer ? `${lastCustomer.givenName || 'Customer'} ${lastCustomer.familyName || ''}`.trim() : null
  - const balanceMetrics = []
  - balanceMetrics.push({ label: "Cards on file", value: cardCustomers.length, meta: cardCoverage ? `${cardCoverage}% coverage` : "Sync to unlock" })
  - balanceMetrics.push({ label: "Manual billing", value: manualCustomers, meta: manualCustomers === 1 ? "Needs reminder" : "Need reminders" })
  - balanceMetrics.push({ label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job staged" : "Jobs staged" })
  main.dashboard(data-reminders=reminderCountValue data-overdue=invoiceTicker.overdueInvoiceCount)
    section.balance-card.balance-card--hero
      .balance-card__top
        span.balance-label Customer Directory
        span.balance-meta= cardCoverage ? `${cardCoverage}% cards on file` : "Sync to unlock coverage"
      h2.balance-value #{totalCustomers} Active Customers
      ul.balance-card__metrics
        each metric in balanceMetrics
          li.balance-metric
            span.balance-metric__label #{metric.label}
            span.balance-metric__value #{metric.value}
            span.balance-metric__meta #{metric.meta}

    section.quick-actions
      .action-card
        span.action-card__icon
          svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
            path(d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
        h3 Add Service
        p Launch catalog with curated services per location.
        a.button.button-secondary.button-sm(href=managementHref) Go to catalog
      .action-card
        span.action-card__icon
          svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
            path(d="M5 4h14v16H5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round")
        h3 Create Invoice
        p Build an invoice or estimate with autopay preferences.
        a.button.button-secondary.button-sm(href=invoiceHref) Launch composer
      .action-card
        span.action-card__icon
          svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
            path(d="M4 12h16M4 6h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round")
        h3 Payout Console
        p Monitor rails, approvals, and cash positions.
        a.button.button-secondary.button-sm(href="/payouts/console") View console

    section.money-section
      h2.section-label Command Surface
      .service-actions
        .service-card
          .service-card__icon
            span ðŸ“Š
          h3 Reminder Pipeline
          p.text-secondary AI pacing keeps finance teams ahead of due dates.
          ul.metric-stack
            each signal in heroSignals
              li
                span.metric-label #{signal.label}
                span.metric-value #{signal.value}
                span.metric-meta #{signal.meta}
        .service-card
          .service-card__icon
            span ðŸ§¾
          h3 Invoice Pulse
          p.text-secondary Track overdue pressure and scheduled cash-in.
          .stat-stack-grid
            .stat-stack
              span.stat-label Overdue invoices
              span.stat-value #{invoiceTicker.overdueInvoiceCount}
              span.stat-meta= invoiceTicker.overdueInvoiceCount ? "Escalate with ops" : "All clear"
            .stat-stack
              span.stat-label Scheduled / unpaid
              span.stat-value #{invoiceTicker.scheduledInvoiceCount}
              span.stat-meta Billing in next 7 days
          .pill-row
            a.pill-button(href="/analytics") Analytics
            a.pill-button(href="/admin/reminders") Reminder Queue
        .service-card
          .service-card__icon
            span ðŸ™‹
          h3 Customer Snapshot
          if customerBadge
            p.text-secondary Latest sync: #{customerBadge}
          else
            p.text-secondary Waiting for first customer sync.
          ul.metric-stack
            li
              span.metric-label Cards on file
              span.metric-value #{cardCustomers.length}
              span.metric-meta= `${cardCoverage}% of directory`
            li
              span.metric-label Manual billing
              span.metric-value #{manualCustomers}
              span.metric-meta Requires reminders
          span.status-pill.status-pill--neutral Directory pulse

    section.money-section
      h2.section-label Operations Radar
      .feature-grid
        .feature-card.feature-card--wide
          span.feature-card__eyebrow Env status
          h3 Modern Customer Workspace
          p.text-secondary Manage clients, invoices, reminders, and analytics from a single command center.
          span.hero__panel-chip.hero__panel-chip--status #{statusLabel}
        .feature-card
          span.feature-card__eyebrow Automation
          h3 #{reminderCountValue} reminders staged
          p.text-secondary Jobs continue running while you focus elsewhere.
          a.button.button-secondary.button-sm(href="/admin/reminders") Review queue
        .feature-card
          span.feature-card__eyebrow Insights
          h3 View Analytics
          p.text-secondary Surface KPIs, backlog, and reminder runs in one dashboard.
          a.button.button-secondary.button-sm(href="/analytics") Open analytics

  .reminder-toast(data-toast role="status" aria-live="polite")
    span.toast-dot
    span.toast-message Reminder queue synced.
    button.toast-close(type="button" aria-label="Dismiss notification") Ã—

block commandDrawer
  -
    const drawerLinks = [
      { label: "Dashboard", href: "/" },
      { label: "Customer Hub", href: '/customers', match: ['/customers', '/management'] },
      { label: "Invoices", href: invoiceHref },
      { label: "Estimates", href: estimateHref },
      { label: "Subscriptions", href: subscriptionHref },
      { label: "Analytics", href: "/analytics" },
      { label: "Reminder Queue", href: "/admin/reminders" },
      { label: "Settings", href: settingsHref }
    ];
  -
    const drawerActions = [
      { label: "Create Invoice", href: managementHref, tone: "primary" },
      { label: "Run Reminder Queue", href: "/admin/reminders", tone: "secondary" }
    ];
  +commandDrawer({ links: drawerLinks, actions: drawerActions, currentPath })
