//- Copyright 2020 Square Inc.
 
//- Licensed under the Apache License, Version 2.0 (the "License");
//- you may not use this file except in compliance with the License.
//- You may obtain a copy of the License at
 
//-     http://www.apache.org/licenses/LICENSE-2.0
 
//- Unless required by applicable law or agreed to in writing, software
//- distributed under the License is distributed on an "AS IS" BASIS,
//- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//- See the License for the specific language governing permissions and
//- limitations under the License. 

extends layout

block hero
  - var heroStatusLabel = (envStatus && envStatus.label) || 'Testing'
  +darkHero({
    title: "Modern Customer Workspace",
    subtitle: "Manage clients, invoices, reminders, and analytics from a single hub designed for finance teams on the go.",
    actions: [
      { type: "primary", label: "Add New Customer", href: "/customers/new" },
      { type: "secondary", label: "View Analytics", href: "/analytics" }
    ],
    status: {
      label: heroStatusLabel === 'Live' ? 'Live Environment' : 'Testing Environment',
      tone: heroStatusLabel === 'Live' ? 'success' : 'warning'
    }
  })


block content
  - const totalCustomers = customers.length
  - const cardCustomers = customers.filter((customer) => customer.cards && customer.cards.length)
  - const manualCustomers = totalCustomers - cardCustomers.length
  - const lastCustomer = customers[0]
  - const statusLabel = typeof heroStatusLabel !== 'undefined' ? heroStatusLabel : (envStatus && envStatus.label) || 'Testing'
  - const primaryCustomerId = lastCustomer && lastCustomer.id
  - const customerDetailHref = primaryCustomerId ? `/management/${locationId}/${primaryCustomerId}` : '/customers/new'
  - const managementHref = customerDetailHref
  - const invoiceHref = customerDetailHref
  - const estimateHref = primaryCustomerId ? `/estimate/new/${locationId}/${primaryCustomerId}` : '/customers/new'
  - const subscriptionHref = primaryCustomerId ? `/subscription/new/${locationId}/${primaryCustomerId}` : '/customers/new'
  - const reminderCountValue = typeof reminderCount === 'number' ? reminderCount : 0
  - const settingsHref = '/admin'
  - const safeTickerStats = tickerStats || { upcomingReminders: 0, overdueReminders: 0 }
  - const invoiceTicker = invoiceStats || { overdueInvoiceCount: 0, scheduledInvoiceCount: 0 }
  - const tickerItems = []
  - tickerItems.push({ label: statusLabel === 'Live' ? 'Next settlement ETA' : 'Next sandbox sync', value: statusLabel === 'Live' ? '2h 15m' : 'Sandbox sync in 2h' })
  - tickerItems.push({ label: 'Upcoming reminders', value: safeTickerStats.upcomingReminders })
  - tickerItems.push({ label: 'Overdue reminders', value: safeTickerStats.overdueReminders })
  - tickerItems.push({ label: 'Overdue invoices', value: invoiceTicker.overdueInvoiceCount })
  - tickerItems.push({ label: 'Scheduled invoices', value: invoiceTicker.scheduledInvoiceCount })
  main.dashboard(data-reminders=reminderCountValue data-overdue=invoiceTicker.overdueInvoiceCount)
    section.hero
      .container
        .hero__ribbon
          form.hero__search-bar(action="/management" method="get")
            input(type="text" name="q" aria-label="Search customers, invoices, or services" placeholder="Quick search customers, invoices, or services" autocomplete="off")
            button(type="submit" aria-label="Submit search")
              svg(width="18" height="18" viewBox="0 0 24 24" fill="none")
                path(d="M10 4a6 6 0 106 6 6 6 0 00-6-6zm11 16l-4.5-4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
          .hero__quick-actions
            a.button.button-sm(href="/management") Add Service
            a.button.button-sm(href="/invoice/create") Create Invoice
            a.button.button-sm(href="/payouts/console") Payout Console
        .hero__ticker(role="status" aria-live="polite")
          .ticker-track
            each item in tickerItems
              .ticker-item
                span.ticker-label #{item.label}
                span.ticker-value #{item.value}
        .hero__cta-group
          a.button.button-primary.button-lg(href="/customers/new")
            svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
              path(d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
            | Add New Customer
          a.button.button-ghost.button-lg(href="/analytics") View Analytics
        .hero__metrics
          .metric-card
            span.metric-label Total Customers
            span.metric-value #{totalCustomers}
            span.metric-trend Up-to-the-minute sync
          .metric-card
            span.metric-label Cards on File
            span.metric-value #{cardCustomers.length}
            span.metric-trend= totalCustomers ? `${Math.round((cardCustomers.length/totalCustomers)*100)}% of portfolio` : '0%'
          .metric-card
            span.metric-label Manual Billing
            span.metric-value #{manualCustomers}
            span.metric-trend Requires reminders

    section.highlights
      .container
        .card-grid
          .feature-card
            h3 Feature Spotlight
            p AI-assisted reminders were sent automatically using your cadence.
            a.button.button-secondary(href="/admin/reminders") Review queue
          .feature-card
            h3 Latest Activity
            if lastCustomer
              p Last synced customer:
              p.feature-highlight #{lastCustomer.givenName || 'Customer'} #{lastCustomer.familyName}
            else
              p.feature-highlight Waiting for first customer sync
            a.button.button-secondary(href="/customers") View directory
          .feature-card
            h3 Quick Filters
            ul.quick-filter-list
              li
                span.status-chip.status-chip--success With Card (#{cardCustomers.length})
              li
                span.status-chip.status-chip--warning Manual pay (#{manualCustomers})
              li
                span.status-chip.status-chip--neutral All Customers (#{totalCustomers})
          .feature-card
            h3 Payout Pulse
            if payoutStats
              p.text-secondary #{payoutStats.total} payout events logged
              p.feature-highlight #{payoutStats.pending} pending via #{payoutStats.lastRail || 'rail TBD'}
            else
              p.text-secondary No payouts initiated yet.
            a.button.button-secondary(href="/payouts/console") Manage payouts

  .reminder-toast(data-toast role="status" aria-live="polite")
    span.toast-dot
    span.toast-message Reminder queue synced.
    button.toast-close(type="button" aria-label="Dismiss notification") Ã—

block commandDrawer
  -
    const drawerLinks = [
      { label: "Dashboard", href: "/" },
      { label: "Customer Hub", href: '/customers', match: ['/customers', '/management'] },
      { label: "Invoices", href: invoiceHref },
      { label: "Estimates", href: estimateHref },
      { label: "Subscriptions", href: subscriptionHref },
      { label: "Analytics", href: "/analytics" },
      { label: "Reminder Queue", href: "/admin/reminders" },
      { label: "Settings", href: settingsHref }
    ];
  -
    const drawerActions = [
      { label: "Create Invoice", href: managementHref, tone: "primary" },
      { label: "Run Reminder Queue", href: "/admin/reminders", tone: "secondary" }
    ];
  +commandDrawer({ links: drawerLinks, actions: drawerActions, currentPath })
