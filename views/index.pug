//- Copyright 2020 Square Inc.
 
//- Licensed under the Apache License, Version 2.0 (the "License");
//- you may not use this file except in compliance with the License.
//- You may obtain a copy of the License at
 
//-     http://www.apache.org/licenses/LICENSE-2.0
 
//- Unless required by applicable law or agreed to in writing, software
//- distributed under the License is distributed on an "AS IS" BASIS,
//- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//- See the License for the specific language governing permissions and
//- limitations under the License. 

extends layout
block appHeader

block pageVars
  - const pageKey = 'dashboard';
  - const heroStatusLabel = (envStatus && envStatus.label) || 'Testing';
  - const currentUserName = currentUser && currentUser.name ? currentUser.name : "Ops Analyst";
  - const currentUserRole = currentUser && currentUser.role ? currentUser.role : "viewer";
  - const currentUserRoleLabel = currentUserRole.replace(/\b\w/g, (char) => char.toUpperCase());
  - const totalCustomers = customers.length;
  - const cardCustomers = customers.filter((customer) => customer.cards && customer.cards.length);
  - const manualCustomers = totalCustomers - cardCustomers.length;
  - const lastCustomer = customers[0];
  - const primaryCustomerId = lastCustomer && lastCustomer.id;
  - const customerDetailHref = primaryCustomerId ? `/management/${locationId}/${primaryCustomerId}` : '/customers/new';
  - const managementHref = customerDetailHref;
  - const invoiceHref = customerDetailHref;
  - const estimateHref = primaryCustomerId ? `/estimate/new/${locationId}/${primaryCustomerId}` : '/customers/new';
  - const subscriptionHref = primaryCustomerId ? `/subscription/new/${locationId}/${primaryCustomerId}` : '/customers/new';
  - const reminderCountValue = typeof reminderCount === 'number' ? reminderCount : 0;
  - const directoryCustomers = Array.isArray(displayCustomers) ? displayCustomers : (customers || []);
  - const settingsHref = '/admin';
  - const safeTickerStats = tickerStats || { upcomingReminders: 0, overdueReminders: 0 };
  - const invoiceTicker = invoiceStats || { overdueInvoiceCount: 0, scheduledInvoiceCount: 0 };
  - const payoutStatsSafe = payoutStats || { total: 0, pending: 0, lastRail: null };
  - const heroSignals = [];
  - heroSignals.push({ label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job waiting to send" : `${reminderCountValue} reminders staged` });
  - heroSignals.push({ label: "Upcoming reminders", value: safeTickerStats.upcomingReminders, meta: "Next 24h window" });
  - heroSignals.push({ label: "Overdue reminders", value: invoiceTicker.overdueInvoiceCount, meta: invoiceTicker.overdueInvoiceCount ? "Escalate with ops" : "All clear" });
  - heroSignals.push({ label: "Scheduled invoices", value: invoiceTicker.scheduledInvoiceCount, meta: "In-flight billing" });
  - const cardCoverage = totalCustomers ? Math.round((cardCustomers.length / totalCustomers) * 100) : 0;
  - const statusLabel = heroStatusLabel;
  - const balanceMetrics = [];
  - balanceMetrics.push({ label: "Cards on file", value: cardCustomers.length, meta: cardCoverage ? `${cardCoverage}% coverage` : "Sync to unlock" });
  - balanceMetrics.push({ label: "Manual billing", value: manualCustomers, meta: manualCustomers === 1 ? "Needs reminder" : "Need reminders" });
  - balanceMetrics.push({ label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job staged" : "Jobs staged" });
  - const statusStripMetrics = [];
  - statusStripMetrics.push({ label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job staged" : "Jobs staged" });
  -
    statusStripMetrics.push({
      label: "Upcoming reminders",
      value: safeTickerStats.upcomingReminders,
      meta: "Next 24h window",
      delta:
        safeTickerStats.upcomingReminders > 5
          ? { label: "High load", tone: "danger" }
          : null,
    });
  -
    statusStripMetrics.push({
      label: "Overdue invoices",
      value: invoiceTicker.overdueInvoiceCount,
      meta: invoiceTicker.overdueInvoiceCount
        ? "Escalate backlog"
        : "All clear",
      delta: invoiceTicker.overdueInvoiceCount
        ? { label: "Attention", tone: "danger" }
        : { label: "Clear", tone: "info" },
    });
  - const actionDockOptions = {};
  - actionDockOptions.primaryHref = invoiceHref;
  - actionDockOptions.queueHref = "/admin/reminders";
  - actionDockOptions.context = 'dashboard';
  - const headerMetrics = statusStripMetrics;
  - const headerTitle = "Command Center";
  - const headerSecondary = heroStatusLabel;
  - const enableAuxPanel = true;
  - const overduePercent = totalCustomers ? Math.min(invoiceTicker.overdueInvoiceCount / totalCustomers, 1) : 0;
  - const reminderPercent = Math.min(reminderCountValue / Math.max(invoiceTicker.scheduledInvoiceCount || 8, 8), 1);
  - const payoutSegments = [];
  - payoutSegments.push({ label: "Pending", value: payoutStatsSafe.pending || 0 });
  - payoutSegments.push({ label: "Complete", value: Math.max((payoutStatsSafe.total || 0) - (payoutStatsSafe.pending || 0), 0) });
  - const timelineEntries = Array.isArray(reminderTimeline) ? reminderTimeline : [];
  - const customerBadge = lastCustomer ? `${lastCustomer.givenName || 'Customer'} ${lastCustomer.familyName || ''}`.trim() : null;

block hero
  section.dashboard-hero
    .dashboard-hero__header
      button.dashboard-hero__menu.hero__nav-trigger(type="button" aria-label="Open navigation panel")
        span
        span
        span
      .dashboard-hero__summary
        span.dashboard-hero__eyebrow Navigate & Automate
        h1.dashboard-hero__title Cashly Command
        span.dashboard-hero__subtitle= `${currentUserRoleLabel} Â· ${currentUserName}`
      .dashboard-hero__brand
        .dashboard-hero__brand-pill
          span Cashly OS
        .dashboard-hero__badge
          span.dashboard-hero__badge-dot
          span= heroStatusLabel
    ul.dashboard-hero__chips
      li.dashboard-hero__chip Dashboard
      li.dashboard-hero__chip= (envStatus && envStatus.label) || "Testing"
      li.dashboard-hero__chip= payoutStatsSafe.lastRail ? `Last rail: ${payoutStatsSafe.lastRail}` : "Ready to sync"
    .dashboard-hero__stats
      each metric in heroSignals
        .dashboard-hero__card
          span.dashboard-hero__card-label= metric.label
          span.dashboard-hero__card-value= metric.value
          span.dashboard-hero__card-meta= metric.meta

block statusStrip

block content
  - const slugify = (label) => (label || '').toString().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '')
  - const formatTimelineTime = (timestamp) => {
  -   const date = new Date(timestamp);
  -   return Number.isNaN(date.getTime()) ? 'Queued' : date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  - }
  - const timelineTone = (type) => type && type.includes('OVERDUE') ? 'danger' : 'info';
  - const nowTs = Date.now();
  - const sparkEntries = timelineEntries.slice(0, 10);
  - let sparkPoints = [{ value: 1 }];
  - if (sparkEntries.length) {
  -   sparkPoints = sparkEntries.map((entry, index) => {
  -     const ts = entry.runAt ? new Date(entry.runAt).getTime() : nowTs;
  -     const hoursOut = Math.max(0, (ts - nowTs) / (60 * 60 * 1000));
  -     return { value: Math.max(1, 24 - Math.min(24, hoursOut)), label: entry.type || `event-${index}` };
  -   });
  - }
  main.dashboard(data-reminders=reminderCountValue data-overdue=invoiceTicker.overdueInvoiceCount)
    .dashboard-shell
      .dashboard-shell__primary
        section.kpi-deck
          .kpi-deck__item
            +kpiGauge({
              label: "Overdue coverage",
              percent: overduePercent,
              meta: `${invoiceTicker.overdueInvoiceCount} overdue / ${totalCustomers || 0} customers`
            })
          .kpi-deck__item
            +sparkCard({
              label: "Reminder cadence",
              total: `${reminderCountValue} jobs`,
              points: sparkPoints,
              meta: "Next 24h reach"
            })
          .kpi-deck__item
            +segmentProgress({
              label: "Payout pipeline",
              segments: payoutSegments,
              meta: `${payoutStatsSafe.pending || 0} pending of ${payoutStatsSafe.total || 0}`
            })
        section.balance-card.balance-card--hero(data-collapsible)
          button.balance-card__toggle(type="button" data-collapsible-trigger)
            div
              span.balance-label Customer Directory
              small.balance-meta= cardCoverage ? `${cardCoverage}% cards on file` : "Sync to unlock coverage"
            span.balance-card__indicator
          .balance-card__summary
            h2.balance-value #{totalCustomers} Active Customers
            .chip-row
              each metric, metricIndex in balanceMetrics
                - const metricSlug = slugify(metric.label)
                span.metric-chip(
                  data-metric-chip=metricSlug
                )
                  span.metric-chip__value #{metric.value}
                  span.metric-chip__label #{metric.label}
          .balance-card__details(data-collapsible-content)
            ul.balance-card__metrics
              each metric, detailIndex in balanceMetrics
                - const detailSlug = slugify(metric.label)
                li.balance-metric(
                  data-metric-chip=detailSlug
                )
                  span.balance-metric__label #{metric.label}
                  span.balance-metric__value #{metric.value}
                  span.balance-metric__meta #{metric.meta}

        section.quick-actions
          .action-card
            span.action-card__icon
              svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
                path(d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
            h3 Add Service
            p Launch catalog with curated services per location.
            a.button.button-secondary.button-sm(href=managementHref) Go to catalog
          .action-card
            span.action-card__icon
              svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
                path(d="M5 4h14v16H5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round")
            h3 Create Invoice
            p Build an invoice or estimate with autopay preferences.
            a.button.button-secondary.button-sm(href=invoiceHref) Launch composer
          .action-card
            span.action-card__icon
              svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
                path(d="M4 12h16M4 6h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round")
            h3 Payout Console
            p Monitor rails, approvals, and cash positions.
            a.button.button-secondary.button-sm(href="/payouts/console") View console

        section.money-section
          h2.section-label Command Surface
          .service-actions
            .service-card
              .service-card__icon
                span ðŸ“Š
              h3 Reminder Pipeline
              p.text-secondary AI pacing keeps finance teams ahead of due dates.
              ul.metric-stack
                each signal, signalIndex in heroSignals
                  - const signalSlug = slugify(signal.label)
                  li(
                    data-metric-chip=signalSlug
                  )
                    span.metric-label #{signal.label}
                    span.metric-value #{signal.value}
                    span.metric-meta #{signal.meta}
            .service-card
              .service-card__icon
                span ðŸ§¾
              h3 Invoice Pulse
              p.text-secondary Track overdue pressure and scheduled cash-in.
              .stat-stack-grid
                .stat-stack(data-metric-chip=slugify("Overdue invoices"))
                  span.stat-label Overdue invoices
                  span.stat-value #{invoiceTicker.overdueInvoiceCount}
                  span.stat-meta= invoiceTicker.overdueInvoiceCount ? "Escalate with ops" : "All clear"
                .stat-stack(data-metric-chip=slugify("Scheduled invoices"))
                  span.stat-label Scheduled / unpaid
                  span.stat-value #{invoiceTicker.scheduledInvoiceCount}
                  span.stat-meta Billing in next 7 days
              .pill-row
                a.pill-button(href="/analytics") Analytics
                a.pill-button(href="/admin/reminders") Reminder Queue
            .service-card
              .service-card__icon
                span ðŸ™‹
              h3 Customer Snapshot
              if customerBadge
                p.text-secondary Latest sync: #{customerBadge}
              else
                p.text-secondary Waiting for first customer sync.
              ul.metric-stack
                li
                  span.metric-label Cards on file
                  span.metric-value #{cardCustomers.length}
                  span.metric-meta= `${cardCoverage}% of directory`
                li
                  span.metric-label Manual billing
                  span.metric-value #{manualCustomers}
                  span.metric-meta Requires reminders
              span.status-pill.status-pill--neutral Directory pulse

        section.money-section
          h2.section-label Operations Radar
          .feature-grid
            .feature-card.feature-card--wide(data-collapsible data-expanded)
              button.feature-card__toggle(type="button" data-collapsible-trigger)
                span.feature-card__eyebrow Env status
                span.feature-card__indicator
              .feature-card__summary
                h3 Modern Customer Workspace
                span.hero__panel-chip.hero__panel-chip--status #{statusLabel}
              .feature-card__details(data-collapsible-content)
                p.text-secondary Manage clients, invoices, reminders, and analytics from a single command center.
            .feature-card(data-collapsible)
              button.feature-card__toggle(type="button" data-collapsible-trigger)
                span.feature-card__eyebrow Automation
                span.feature-card__indicator
              .feature-card__summary
                h3 #{reminderCountValue} reminders staged
              .feature-card__details(data-collapsible-content)
                p.text-secondary Jobs continue running while you focus elsewhere.
                ul.metric-chips
                  li.metric-chip(
                    data-metric-chip=slugify("Reminder queue")
                  )
                    span.metric-chip__value #{reminderCountValue}
                    span.metric-chip__label Queue size
                a.button.button-secondary.button-sm(href="/admin/reminders") Review queue
            .feature-card(data-collapsible)
              button.feature-card__toggle(type="button" data-collapsible-trigger)
                span.feature-card__eyebrow Insights
                span.feature-card__indicator
              .feature-card__summary
                h3 View Analytics
              .feature-card__details(data-collapsible-content)
                p.text-secondary Surface KPIs, backlog, and reminder runs in one dashboard.
                a.button.button-secondary.button-sm(href="/analytics") Open analytics

  .reminder-toast(data-toast role="status" aria-live="polite")
    span.toast-dot
    span.toast-message Reminder queue synced.
    button.toast-close(type="button" aria-label="Dismiss notification") Ã—

block auxPanel
  .timeline-panel(data-pin-target)
    .timeline-panel__header
      .timeline-panel__title
        span.timeline-panel__eyebrow Reminder timeline
        h3 Timeline queue
      button.timeline-panel__toggle(type="button" data-rail-toggle)
        span Toggle panel
    if timelineEntries && timelineEntries.length
      ul.timeline-panel__list
        each event, timelineIndex in timelineEntries
          - const tone = timelineTone(event.type);
          li.timeline-panel__item(class=`timeline-panel__item--${tone}`)
            span.timeline-panel__time= formatTimelineTime(event.runAt)
            h4.timeline-panel__label= event.message || event.type
            if event.invoiceId
              span.timeline-panel__meta= `Invoice ${event.invoiceId}`
            else
              span.timeline-panel__meta Broadcast
    else
      .timeline-panel__empty
        span.timeline-panel__emoji ðŸ›°
        p No reminders staged â€” queue idle.
