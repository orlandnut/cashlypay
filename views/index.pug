//- Copyright 2020 Square Inc.
 
//- Licensed under the Apache License, Version 2.0 (the "License");
//- you may not use this file except in compliance with the License.
//- You may obtain a copy of the License at
 
//-     http://www.apache.org/licenses/LICENSE-2.0
 
//- Unless required by applicable law or agreed to in writing, software
//- distributed under the License is distributed on an "AS IS" BASIS,
//- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//- See the License for the specific language governing permissions and
//- limitations under the License. 

extends layout
- const pageKey = 'dashboard';
- const heroStatusLabel = (envStatus && envStatus.label) || 'Testing';
- const totalCustomers = customers.length;
- const cardCustomers = customers.filter((customer) => customer.cards && customer.cards.length);
- const manualCustomers = totalCustomers - cardCustomers.length;
- const lastCustomer = customers[0];
- const primaryCustomerId = lastCustomer && lastCustomer.id;
- const customerDetailHref = primaryCustomerId ? `/management/${locationId}/${primaryCustomerId}` : '/customers/new';
- const managementHref = customerDetailHref;
- const invoiceHref = customerDetailHref;
- const estimateHref = primaryCustomerId ? `/estimate/new/${locationId}/${primaryCustomerId}` : '/customers/new';
- const subscriptionHref = primaryCustomerId ? `/subscription/new/${locationId}/${primaryCustomerId}` : '/customers/new';
- const reminderCountValue = typeof reminderCount === 'number' ? reminderCount : 0;
- const directoryCustomers = Array.isArray(displayCustomers) ? displayCustomers : (customers || []);
- const settingsHref = '/admin';
- const safeTickerStats = tickerStats || { upcomingReminders: 0, overdueReminders: 0 };
- const invoiceTicker = invoiceStats || { overdueInvoiceCount: 0, scheduledInvoiceCount: 0 };
- const heroSignals = [];
- heroSignals.push({ label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job waiting to send" : `${reminderCountValue} reminders staged` });
- heroSignals.push({ label: "Upcoming reminders", value: safeTickerStats.upcomingReminders, meta: "Next 24h window" });
- heroSignals.push({ label: "Overdue reminders", value: safeTickerStats.overdueReminders, meta: safeTickerStats.overdueReminders ? "Escalate with ops" : "All clear" });
- heroSignals.push({ label: "Scheduled invoices", value: invoiceTicker.scheduledInvoiceCount, meta: "In-flight billing" });
- const cardCoverage = totalCustomers ? Math.round((cardCustomers.length / totalCustomers) * 100) : 0;
- const statusLabel = heroStatusLabel;
- const balanceMetrics = [];
- balanceMetrics.push({ label: "Cards on file", value: cardCustomers.length, meta: cardCoverage ? `${cardCoverage}% coverage` : "Sync to unlock" });
- balanceMetrics.push({ label: "Manual billing", value: manualCustomers, meta: manualCustomers === 1 ? "Needs reminder" : "Need reminders" });
- balanceMetrics.push({ label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job staged" : "Jobs staged" });
- const statusStripMetrics = [
-   { label: "Reminder queue", value: reminderCountValue, meta: reminderCountValue === 1 ? "Job staged" : "Jobs staged" },
-   { label: "Upcoming reminders", value: safeTickerStats.upcomingReminders, meta: "Next 24h window" },
-   { label: "Overdue invoices", value: invoiceTicker.overdueInvoiceCount, meta: invoiceTicker.overdueInvoiceCount ? "Escalate backlog" : "All clear" }
- ];
- const heroBreadcrumbs = [
-   { label: "Navigate", href: "/" },
-   { label: "Dashboard", active: true }
- ];
- const actionDockOptions = {
-   primaryHref: invoiceHref,
-   queueHref: "/admin/reminders",
-   context: 'dashboard',
-   shortcuts: [
-     { label: "Add Customer", hint: "Customer Hub", href: "/customers/new", tone: "secondary", animateSeq: 5 },
-     { label: "Sync Directory", hint: "Square sandbox", tone: "ghost", attrs: { "data-sync-directory": "true" }, animateSeq: 6 }
-   ]
- };
- const timelineEntries = Array.isArray(reminderTimeline) ? reminderTimeline : [];
- const customerBadge = lastCustomer ? `${lastCustomer.givenName || 'Customer'} ${lastCustomer.familyName || ''}`.trim() : null;

block hero
  +darkHero({
    title: "Modern Customer Workspace",
    subtitle: "Manage clients, invoices, reminders, and analytics from a single hub designed for finance teams on the go.",
    back: false,
    actions: [
      { type: "primary", label: "View Analytics", href: "/analytics" },
      { type: "secondary", label: "Customer Hub", href: "/customers" }
    ],
    envBadge: heroStatusLabel === 'Live' ? 'Live mode' : 'Sandbox mode',
    status: envStatus,
    breadcrumbs: heroBreadcrumbs,
    search: { label: "Search workspace", hint: "âŒ˜K" }
  })

block statusStrip
  +statusStrip(statusStripMetrics)

block content
  - const slugify = (label) => (label || '').toString().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '')
  - const formatTimelineTime = (timestamp) => {
  -   const date = new Date(timestamp);
  -   return Number.isNaN(date.getTime()) ? 'Queued' : date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  - }
  - const timelineTone = (type) => type && type.includes('OVERDUE') ? 'danger' : 'info';
  main.dashboard(data-reminders=reminderCountValue data-overdue=invoiceTicker.overdueInvoiceCount)
    .dashboard-shell
      .dashboard-shell__primary
        section.balance-card.balance-card--hero(data-collapsible)
          button.balance-card__toggle(type="button" data-collapsible-trigger)
            div
              span.balance-label Customer Directory
          small.balance-meta= cardCoverage ? `${cardCoverage}% cards on file` : "Sync to unlock coverage"
        span.balance-card__indicator
      .balance-card__summary(data-shimmer="true")
        h2.balance-value #{totalCustomers} Active Customers
        .chip-row
          each metric, metricIndex in balanceMetrics
            - const metricSlug = slugify(metric.label)
            span.metric-chip(
              data-metric-chip=metricSlug
              data-animate-seq=metricIndex
            )
              span.metric-chip__value #{metric.value}
              span.metric-chip__label #{metric.label}
      .balance-card__details(data-collapsible-content)
        ul.balance-card__metrics
          each metric, detailIndex in balanceMetrics
            - const detailSlug = slugify(metric.label)
            li.balance-metric(
              data-metric-chip=detailSlug
              data-animate-seq=detailIndex
            )
              span.balance-metric__label #{metric.label}
              span.balance-metric__value #{metric.value}
              span.balance-metric__meta #{metric.meta}

        section.quick-actions
          .action-card
            span.action-card__icon
              svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
                path(d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round")
            h3 Add Service
            p Launch catalog with curated services per location.
            a.button.button-secondary.button-sm(href=managementHref) Go to catalog
      .action-card
        span.action-card__icon
          svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
            path(d="M5 4h14v16H5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round")
        h3 Create Invoice
        p Build an invoice or estimate with autopay preferences.
        a.button.button-secondary.button-sm(href=invoiceHref) Launch composer
      .action-card
        span.action-card__icon
          svg(width="20" height="20" viewBox="0 0 24 24" fill="none")
            path(d="M4 12h16M4 6h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round")
        h3 Payout Console
        p Monitor rails, approvals, and cash positions.
        a.button.button-secondary.button-sm(href="/payouts/console") View console

        section.money-section
          h2.section-label Command Surface
          .service-actions
        .service-card(data-shimmer="true" data-animate-seq="1")
          .service-card__icon
            span ðŸ“Š
          h3 Reminder Pipeline
          p.text-secondary AI pacing keeps finance teams ahead of due dates.
          ul.metric-stack
            each signal, signalIndex in heroSignals
              - const signalSlug = slugify(signal.label)
              li(
                data-metric-chip=signalSlug
                data-animate-seq=signalIndex
              )
                span.metric-label #{signal.label}
                span.metric-value #{signal.value}
                span.metric-meta #{signal.meta}
        .service-card(data-shimmer="true" data-animate-seq="2")
          .service-card__icon
            span ðŸ§¾
          h3 Invoice Pulse
          p.text-secondary Track overdue pressure and scheduled cash-in.
          .stat-stack-grid
            .stat-stack(data-metric-chip=slugify("Overdue invoices") data-animate-seq="2")
              span.stat-label Overdue invoices
              span.stat-value #{invoiceTicker.overdueInvoiceCount}
              span.stat-meta= invoiceTicker.overdueInvoiceCount ? "Escalate with ops" : "All clear"
            .stat-stack(data-metric-chip=slugify("Scheduled invoices") data-animate-seq="3")
              span.stat-label Scheduled / unpaid
              span.stat-value #{invoiceTicker.scheduledInvoiceCount}
              span.stat-meta Billing in next 7 days
          .pill-row
            a.pill-button(href="/analytics") Analytics
            a.pill-button(href="/admin/reminders") Reminder Queue
        .service-card(data-shimmer="true" data-animate-seq="3")
          .service-card__icon
            span ðŸ™‹
          h3 Customer Snapshot
          if customerBadge
            p.text-secondary Latest sync: #{customerBadge}
          else
            p.text-secondary Waiting for first customer sync.
          ul.metric-stack
            li
              span.metric-label Cards on file
              span.metric-value #{cardCustomers.length}
              span.metric-meta= `${cardCoverage}% of directory`
            li
              span.metric-label Manual billing
              span.metric-value #{manualCustomers}
              span.metric-meta Requires reminders
          span.status-pill.status-pill--neutral Directory pulse

        section.money-section
          h2.section-label Operations Radar
          .feature-grid
        .feature-card.feature-card--wide(data-collapsible data-expanded data-animate-seq="4")
          button.feature-card__toggle(type="button" data-collapsible-trigger)
            span.feature-card__eyebrow Env status
            span.feature-card__indicator
          .feature-card__summary
            h3 Modern Customer Workspace
            span.hero__panel-chip.hero__panel-chip--status #{statusLabel}
          .feature-card__details(data-collapsible-content)
            p.text-secondary Manage clients, invoices, reminders, and analytics from a single command center.
        .feature-card(data-collapsible data-animate-seq="5")
          button.feature-card__toggle(type="button" data-collapsible-trigger)
            span.feature-card__eyebrow Automation
            span.feature-card__indicator
          .feature-card__summary
            h3 #{reminderCountValue} reminders staged
          .feature-card__details(data-collapsible-content)
            p.text-secondary Jobs continue running while you focus elsewhere.
            ul.metric-chips
              li.metric-chip(
                data-metric-chip=slugify("Reminder queue")
                data-animate-seq="6"
              )
                span.metric-chip__value #{reminderCountValue}
                span.metric-chip__label Queue size
            a.button.button-secondary.button-sm(href="/admin/reminders") Review queue
        .feature-card(data-collapsible data-animate-seq="7")
          button.feature-card__toggle(type="button" data-collapsible-trigger)
            span.feature-card__eyebrow Insights
            span.feature-card__indicator
          .feature-card__summary
            h3 View Analytics
          .feature-card__details(data-collapsible-content)
            p.text-secondary Surface KPIs, backlog, and reminder runs in one dashboard.
            a.button.button-secondary.button-sm(href="/analytics") Open analytics

      aside.dashboard-shell__secondary
        .timeline-panel
          .timeline-panel__header
            .timeline-panel__title
              span.timeline-panel__eyebrow Reminder timeline
              h3 Timeline queue
            button.timeline-panel__toggle(type="button" data-rail-toggle)
              span Toggle panel
          if timelineEntries && timelineEntries.length
            ul.timeline-panel__list
              each event, timelineIndex in timelineEntries
                - const tone = timelineTone(event.type);
                li.timeline-panel__item(class=`timeline-panel__item--${tone}`)
                  span.timeline-panel__time= formatTimelineTime(event.runAt)
                  h4.timeline-panel__label= event.message || event.type
                  if event.invoiceId
                    span.timeline-panel__meta= `Invoice ${event.invoiceId}`
                  else
                    span.timeline-panel__meta Broadcast
          else
            .timeline-panel__empty
              span.timeline-panel__emoji ðŸ›°
              p No reminders staged â€” queue idle.

  .reminder-toast(data-toast role="status" aria-live="polite")
    span.toast-dot
    span.toast-message Reminder queue synced.
    button.toast-close(type="button" aria-label="Dismiss notification") Ã—

block commandDrawer
  -
    const drawerLinks = [
      { label: "Dashboard", href: "/", icon: "#icon-dashboard", meta: "Command overview" },
      { label: "Customer Hub", href: '/customers', match: ['/customers', '/management'], icon: "#icon-invoice", meta: "Accounts & billing" },
      { label: "Invoices", href: invoiceHref, icon: "#icon-invoice", meta: "Composer & history" },
      { label: "Estimates", href: estimateHref, icon: "#icon-dashboard", meta: "Quotes & approvals" },
      { label: "Subscriptions", href: subscriptionHref, icon: "#icon-dashboard", meta: "Recurring services" },
      { label: "Analytics", href: "/analytics", icon: "#icon-dashboard", meta: "KPIs & health" },
      { label: "Reminder Queue", href: "/admin/reminders", icon: "#icon-invoice", meta: "Automation feed" },
      { label: "Settings", href: settingsHref, icon: "#icon-dashboard", meta: "Controls & access" }
    ];
  -
    const drawerActions = [
      { label: "Create Invoice", href: managementHref, tone: "primary" },
      { label: "Run Reminder Queue", href: "/admin/reminders", tone: "danger", confirm: "Run the reminder queue now?" }
    ];
  +commandDrawer({ links: drawerLinks, actions: drawerActions, currentPath, status: envStatus })
