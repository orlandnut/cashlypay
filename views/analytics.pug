extends layout

block hero
  +darkHero({
    title: "Ops & Billing Analytics",
    subtitle: "Quick health check on reminders and lifecycle activity.",
    actions: [
      { type: "primary", label: "Reminder Queue", href: "/admin/reminders" },
      { type: "secondary", label: "Refresh", href: "/analytics" }
    ]
  })


block content
  .dashboard
    section.section.panel
      form.filters(method="get" action="/analytics")
        label
          span.text-secondary Filter activity by type
          select(name="type" onchange="this.form.submit()")
            option(value="ALL" selected=filters.type === 'ALL') All Events
            option(value="REMINDER_SENT" selected=filters.type === 'REMINDER_SENT') Reminders
        label
          span.text-secondary Timeframe
          select(name="range" onchange="this.form.submit()")
            option(value="24h" selected=filters.range === '24h') Last 24h
            option(value="7d" selected=filters.range === '7d') Last 7d
            option(value="30d" selected=filters.range === '30d') Last 30d
            option(value="all" selected=filters.range === 'all') All time
      .analytics-grid
        .analytics-card
          span.label Total Events
          span.value #{metrics.totalEvents}
          div.sparkline.sparkline--events
          span.text-secondary Includes all activity log entries
        .analytics-card
          span.label Reminders Sent
          span.value #{metrics.totalReminders}
          div.sparkline.sparkline--reminders
          span.text-secondary Lifecycle nudges dispatched
        .analytics-card
          span.label Reminders Backlog
          span.value #{metrics.reminderBacklog}
          div.sparkline.sparkline--backlog
          span.text-secondary Scheduled jobs pending
        .analytics-card
          span.label Milestone Pipeline
          span.value $#{(metrics.milestoneTotal/100).toFixed(2)}
          div.sparkline.sparkline--milestones
          if metrics.milestoneBuckets && metrics.milestoneBuckets.length
            span.text-secondary
              = metrics.milestoneBuckets.map((bucket) => `${bucket.status}: ${bucket.count}`).join(' · ')
          else
            span.text-secondary Scheduled stages

    section.section.panel
      h3.section-title Recent Activity
      if recentActivities && recentActivities.length
        .activity-list
          each item in recentActivities
            .activity-item
              .activity-meta
                span #{item.type}
                span #{item.timestamp}
              if item.payload
                pre= JSON.stringify(item.payload, null, 2)
              else
                p.text-secondary No payload
      else
        p.text-secondary No activity logged yet.

    section.section.panel
      h3.section-title Upcoming Milestones
      if upcomingMilestones && upcomingMilestones.length
        table.milestone-table
          thead
            tr
              th Label
              th Invoice
              th Due date
              th Amount
          tbody
            each milestone in upcomingMilestones
              tr
                td #{milestone.label}
                td ##{milestone.invoiceId ? milestone.invoiceId.slice(-6) : '—'}
                td= milestone.dueDate || 'No date'
                td $#{(milestone.amount/100).toFixed(2)}
      else
        p.text-secondary No upcoming milestones scheduled.
