extends layout

block hero
  +darkHero({
    title: "Gift Card Control",
    subtitle: "Issue, load, and monitor Square gift cards without leaving Cashly.",
    status: envStatus,
    actions: [
      { type: "primary", label: "Issue card", href: "#issue-card" },
      { type: "secondary", label: "Record load", href: "#load-card" }
    ]
  })

block content
  - const formatMoney = (money) => {
  -   const amount = money && typeof money.amount === 'number' ? money.amount : 0;
  -   const currency = (money && money.currency) || 'USD';
  -   return `$${(amount / 100).toFixed(2)} ${currency}`;
  - };
  - const formatDate = (value) => value ? new Date(value).toLocaleString() : '—';
  if message
    .toast-banner.toast-banner--success
      span Gift card action #{message === 'loaded' ? 'recorded' : 'completed'} successfully.
  if errorMessage
    .toast-banner.toast-banner--error
      span= errorMessage

  section.gift-card-grid(data-collapsible data-expanded)
    button.section-toggle(type="button" data-collapsible-trigger)
      span Gift card overview
      span.section-toggle__meta= `${stats.totalIssued} issued`
    ul.peek-chips
      li.peek-chip= `${stats.activeCards} active`
      li.peek-chip= `${stats.blockedCards + stats.deactivatedCards} blocked`
      li.peek-chip= formatMoney({ amount: stats.totalBalance, currency: 'USD' })
    .gift-card-grid__body(data-collapsible-content)
      .gift-card-stat
        span.stat-label Total issued
        strong.stat-value #{stats.totalIssued}
        span.stat-meta All card states
      .gift-card-stat
        span.stat-label Active
        strong.stat-value #{stats.activeCards}
        span.stat-meta Ready for spend
      .gift-card-stat
        span.stat-label Blocked / Inactive
        strong.stat-value #{stats.blockedCards + stats.deactivatedCards}
        span.stat-meta Controls engaged
      .gift-card-stat
        span.stat-label Balance outstanding
        strong.stat-value= formatMoney({ amount: stats.totalBalance, currency: 'USD' })
        span.stat-meta Across visible cards
  if syncMeta
    section.sync-meta(data-collapsible data-expanded)
      button.section-toggle(type="button" data-collapsible-trigger)
        span Sync health
        span.section-toggle__meta= syncMeta.lastReconciledAt ? `Reconciled ${formatDate(syncMeta.lastReconciledAt)}` : "Awaiting first run"
      ul.peek-chips
        li.peek-chip= syncMeta.discrepancies && syncMeta.discrepancies.length ? `${syncMeta.discrepancies.length} issues` : "No issues"
        li.peek-chip= syncMeta.lastReconciledAt ? formatDate(syncMeta.lastReconciledAt) : "Pending sync"
      .sync-meta__body(data-collapsible-content)
        .section-heading
          h2.section-label Sync health
          if syncMeta.lastReconciledAt
            span.section-meta Last run #{formatDate(syncMeta.lastReconciledAt)}
          else
          span.section-meta Awaiting first reconciliation
      if syncMeta.discrepancies && syncMeta.discrepancies.length
        ul.sync-list
          each issue in syncMeta.discrepancies
            li
              div
                strong= issue.kind || 'Alert'
                span.sync-meta-text Card #{issue.giftCardId}
              div
                span.sync-meta-text Detected #{formatDate(issue.detectedAt)}
                if typeof issue.squareBalance === 'number'
                  span.sync-meta-text Square #{(issue.squareBalance / 100).toFixed(2)}
                if typeof issue.cachedBalance === 'number'
                  span.sync-meta-text Cache #{(issue.cachedBalance / 100).toFixed(2)}
      else
        p.text-secondary All good — no discrepancies detected.
  if permissions && permissions.canAuditGiftCards
    section.money-section
      .section-heading
        h2.section-label Audit log
        span.section-meta Tracking recent gift card actions
      if auditLogs && auditLogs.length
        ul.audit-list
          each audit in auditLogs
            li
              div
                span.audit-type= audit.type
                span.audit-meta Actor: #{audit.actor || 'system'}
              div
                span.audit-meta #{formatDate(audit.timestamp)}
                if audit.payload
                  pre.audit-payload= JSON.stringify(audit.payload, null, 2)
      else
        p.text-secondary No audit entries yet.

  if searchMeta && searchMeta.query && searchMeta.notFound
    .toast-banner.toast-banner--error
      span No cards matched "#{searchMeta.query}". Try a different ID or filter.
  if searchMeta && searchMeta.query && !searchMeta.notFound
    .toast-banner.toast-banner--success
      span Showing results for "#{searchMeta.query}".

  section.money-section(data-collapsible data-expanded)
    button.section-toggle(type="button" data-collapsible-trigger)
      span Gift card directory
      span.section-toggle__meta= `${giftCards.length} records`
    ul.peek-chips
      li.peek-chip= filters.type ? `Type: ${filters.type}` : "All types"
      li.peek-chip= filters.state ? `State: ${filters.state}` : "All states"
      if searchMeta && searchMeta.query
        li.peek-chip= `Search: ${searchMeta.query}`
    .money-section__body(data-collapsible-content)
      .section-heading
        h2.section-label Gift card directory
        span.section-meta= `${giftCards.length} records`
    form.filter-bar(action="/gift-cards" method="get" data-filter-form)
      .filter-group
        label
          span Filter by type
          select(name="type")
            option(value="") All types
            each type in filterChoices.types
              option(value=type selected=filters.type === type)= type
      .filter-group
        label
          span Filter by state
          select(name="state")
            option(value="") All states
            each state in filterChoices.states
              option(value=state selected=filters.state === state)= state
      .filter-group
        label
          span Customer ID
          input(type="text" name="customerId" placeholder="cust-id" value=filters.customerId)
      .filter-group
        label
          span Activity card ID
          input(type="text" name="activityCardId" placeholder="card-id" value=filters.activityCardId)
      .filter-group
        label
          span Search ID / GAN
          input(type="text" name="q" placeholder="Search..." value=filters.q)
      .filter-group
        label
          span Cards per page
          select(name="limit")
            each option in filterChoices.limitOptions
              option(value=option selected=filters.limit === option)= option
      .filter-group
        label
          span Activity items
          select(name="activityLimit")
            each option in filterChoices.limitOptions
              option(value=option selected=filters.activityLimit === option)= option
      button.button.button-secondary(type="submit") Apply filters
      if filters.type || filters.state || filters.customerId || filters.activityCardId || filters.q
        a.button.button-ghost(href="/gift-cards") Reset
    .preset-panel
      .preset-panel__header
        h3 Saved presets
        button.button.button-secondary.button-sm(type="button" data-save-preset) Save current
      .preset-buttons
        if filterChoices.presets && filterChoices.presets.length
          each preset in filterChoices.presets
            a.button.button-ghost(href=`/gift-cards?${preset.query}`)= preset.label
        else
          span.preset-empty No presets yet.
      .preset-buttons(data-custom-presets)
    if giftCards && giftCards.length
      .table-wrapper.table-wrapper--interactive(data-table)
        .table-toolbar
          label.table-toolbar__search
            span.sr-only Search cards
            input(type="search" name="inlineSearch" placeholder="Search ID…" data-table-search)
          button.button.button-ghost.button-sm(type="button" data-table-compact-toggle) Compact mode
        table.table.table--interactive(role="grid" data-sticky-head data-table-scroll)
          thead
            tr
              th
                button.sort-button(type="button" data-sort="gan") Scope
              th
                button.sort-button(type="button" data-sort="balance") Balance
              th
                button.sort-button(type="button" data-sort="type") Type
              th
                button.sort-button(type="button" data-sort="state") State
              th Customers
              th
                button.sort-button(type="button" data-sort="createdAt") Created
            tr.table-filter-row
              th
                input(type="text" name="filterGan" placeholder="GAN" data-column-filter="gan")
              th
                input(type="number" name="filterBalance" placeholder=">= amount" data-column-filter="balance")
              th
                input(type="text" name="filterType" placeholder="Type" data-column-filter="type")
              th
                input(type="text" name="filterState" placeholder="State" data-column-filter="state")
              th
                input(type="text" name="filterCustomer" placeholder="Customer" data-column-filter="customer")
              th
                input(type="text" name="filterCreated" placeholder="Date" data-column-filter="createdAt")
          tbody
            each card in giftCards
              tr(
                data-card-row
                data-card-id=card.id
                data-sort-gan=card.gan || card.id
                data-sort-balance=card.balance && card.balance.amount
                data-sort-type=card.type
                data-sort-state=card.state
                data-sort-createdAt=card.createdAt
                tabindex="0"
              )
                td
                  strong= card.gan || card.id
                  if card.id && card.gan
                    span.table-meta ##{card.id.slice(-6)}
                td
                  span.table-amount= formatMoney(card.balance)
                td= card.type
                td
                  - const stateClass = card.state ? `badge--${card.state.toLowerCase()}` : ''
                  span.badge(class=stateClass)= card.state || '—'
                td
                  if card.customerIds && card.customerIds.length
                    span.table-meta= card.customerIds.join(", ")
                  else
                    span.table-meta —
                td
                  span.table-meta= formatDate(card.createdAt)
    else
      p.text-secondary No gift cards yet. Issue your first card below.
    if pagination && pagination.cards
      .pagination-links
        a.button.button-ghost(href=pagination.cards) Load more cards

  if permissions && permissions.canManageGiftCards
    section.money-section.gift-card-forms
      .form-card
        form.gift-card-form(id="issue-card" action="/gift-cards/issue" method="post")
          h3.form-title Issue gift card
          label
            span.form-label Card type
            select(name="type")
              option(value="DIGITAL") Digital
              option(value="PHYSICAL") Physical
          label
            span.form-label Initial amount (USD)
            input(type="number" name="amount" min="0" step="1" placeholder="100" required)
          label
            span.form-label Currency
            input(type="text" name="currency" value="USD" maxlength="3" required)
          label
            span.form-label Link customer (optional)
            input(type="text" name="customerId" placeholder="Search customer..." list="customerOptions" value=filters.customerId)
          if customerOptions && customerOptions.length
            datalist#customerOptions
              each customer in customerOptions
                option(value=customer.id)= `${customer.label}${customer.email ? ' · ' + customer.email : ''}`
          label
            span.form-label Reference (optional)
            input(type="text" name="referenceId" placeholder="Promo, order #, etc.")
          button.button.button-primary(type="submit") Issue & activate
      .form-card
        form.gift-card-form(id="load-card" action="/gift-cards/load" method="post")
          h3.form-title Record load / adjustment
          label
            span.form-label Gift card ID
            input(type="text" name="giftCardId" placeholder="GCXXXX" required)
          label
            span.form-label Amount (USD)
            input(type="number" name="amount" min="1" step="1" required)
          label
            span.form-label Currency
            input(type="text" name="currency" value="USD" maxlength="3" required)
          label
            span.form-label Reference (optional)
            input(type="text" name="referenceId" placeholder="case-123")
          button.button.button-secondary(type="submit") Create load activity
        p.text-secondary.form-hint Use card ID from the directory above; activity logs update instantly.
  else
    section.money-section.gift-card-forms
      p.text-secondary Access to issuing or loading gift cards requires Finance permissions.

  section.money-section
    .section-heading
      h2.section-label Activity timeline
      span.section-meta= `${activities.length} recent events`
    if activities && activities.length
      ul.activity-timeline
        each activity in activities
          li
            div
              span.activity-type= activity.type
              span.activity-meta Card #{activity.giftCardId}
            div
              strong= formatMoney(activity.amount)
              span.activity-meta= formatDate(activity.createdAt)
            div
              span.activity-balance Balance: #{formatMoney(activity.balance)}
    else
      p.text-secondary No activity yet.
    if pagination && pagination.activities
      .pagination-links
        a.button.button-ghost(href=pagination.activities) Load more activity

  .card-overlay(data-card-overlay aria-hidden="true")
    .card-overlay__backdrop(data-card-close)
    .card-overlay__panel
      button.card-overlay__close(type="button" data-card-close aria-label="Close panel") ×
      .card-overlay__header
        span.card-overlay__label Gift Card
        h3.card-overlay__title(data-card-gan) —
        p.card-overlay__meta
          span(data-card-state) —
          span ·
          span(data-card-created) —
      .card-overlay__alert(hidden data-card-alert)
      .card-overlay__balance
        span Balance
        strong(data-card-balance) —
      if permissions && permissions.canManageGiftCards
        .card-overlay__actions
          div
            h4 Block / Unblock
            input(type="text" placeholder="Reason (optional)" data-card-reason)
            .action-buttons
              button.button.button-secondary(type="button" data-action-block) Block card
              button.button.button-ghost(type="button" data-action-unblock) Unblock
          div
            h4 Adjust balance
            form(data-action-adjust)
              input(type="number" step="1" placeholder="Amount (USD)" required data-adjust-amount)
              input(type="text" value="USD" maxlength="3" data-adjust-currency)
              input(type="text" placeholder="Reason (optional)" data-adjust-reason)
              button.button.button-primary(type="submit") Apply adjustment
      else
        .card-overlay__actions
          p.text-secondary Finance role required to manage gift cards.
      .card-overlay__activities
        h4 Recent activity
        ul(data-card-activities)
          li Loading activity...

block append scripts
  script(defer src="/javascripts/gift-cards.js")
